# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

# Helper to extract version name from pubspec.yaml (e.g., "3.0.1")
def get_version_name_from_pubspec
  pubspec_path = "../../pubspec.yaml"
  pubspec_content = File.read(pubspec_path)
  version_match = pubspec_content.match(/version:\s*(\d+\.\d+\.\d+)\+\d+/)
  version_match[1]
end

# Helper to extract version code from pubspec.yaml (e.g., 32)
def get_version_code_from_pubspec
  pubspec_path = "../../pubspec.yaml"
  pubspec_content = File.read(pubspec_path)
  version_match = pubspec_content.match(/version:\s*\d+\.\d+\.\d+\+(\d+)/)
  version_match[1].to_i
end

platform :ios do
  desc "Upload store listing metadata only (descriptions, screenshots)"
  lane :upload_metadata do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true
    )

    deliver(
      api_key: api_key,
      app_version: get_version_name_from_pubspec,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true
    )
  end

  desc "Deploy to App Store (production)"
  lane :deploy_production do
    # Use App Store Connect API key for authentication (CI-friendly)
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true
    )

    version_name = get_version_name_from_pubspec
    version_code = get_version_code_from_pubspec

    UI.message("Deploying version #{version_name} (#{version_code}) to App Store")

    # Build the IPA from pre-built archive (Flutter builds the archive)
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      skip_build_archive: true,
      archive_path: "../build/ios/archive/Runner.xcarchive",
      export_options: {
        method: "app-store",
        signingStyle: "automatic"
      }
    )

    # Upload to App Store
    deliver(
      api_key: api_key,
      ipa: "Runner.ipa",
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: false,
      automatic_release: false,
      force: true,
      app_version: version_name
    )
  end

  desc "Legacy release lane (deprecated - use deploy_production)"
  lane :release do
    increment_build_number(xcodeproj: "Runner.xcodeproj")
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      skip_build_archive: true,
      archive_path: "../build/ios/archive/Runner.xcarchive",
    )
    upload_to_app_store
  end
end
